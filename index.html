<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Refúgio das Flores - Sistema de Gestão</title>
    <link rel="icon" href="images/icone-aba.png" type="image/x-icon" />


    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Tom.js -->
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css">
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

    <!-- Alpine.js -->
    <script
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- External CSS -->
    <link rel="stylesheet" href="style.css" />
  </head>
 <body x-data="flowerShopApp()" :class="!user ? 'login-body' : ''">

    <!-- Tela de Login -->
     <div class="body2">
    <div x-show="!user" class="login-container">
      <div class="login-container">
        <div class="image-section"></div>
        <div class="form-section">
          <div class="nome">
            <h1>SISTEMA DE GESTÃO E CONTROLE DE ESTOQUE</h1>
          </div>

          <div class="divider">Bem-Vindo</div>

          <form @submit.prevent="login()" class="form-block">
            <select x-model="loginData.username" class="form-control" required>
              <option value="">Selecione o usuário</option>
              <option value="LucasP">lucas@refugio.com.br</option>
              <option value="EduardaP">eduarda@refugio.com.br</option>
            </select>
            <input
              type="password"
              x-model="loginData.password"
              placeholder="Senha"
              class="form-control"
              required
            />
            <button type="submit" class="btn" :disabled="loading">
              <span x-show="!loading">Entrar</span>
              <span x-show="loading">Entrando...</span>
            </button>
          </form>

          <div x-show="error" class="alert alert-danger" x-text="error"></div>
       
        </div>
      </div>
    </div>
     
    <!-- Main App -->
    <main x-show="user" class="main-app-container">
      <header class="header">
        <div class="logo">
          <img class="flower-icon" src="logo-b.png" alt="Flower Icon" />
        </div>
        <div class="text-logo">Painel Administrativo</div>
        <div class="user-info">
          <span id="header-username">Usuário</span>
          <button @click="logout()" class="logout-btn">Sair</button>
        </div>
      </header>

      <nav class="nav-tabs-container">
        <ul class="nav-tabs">
          <li>
            <button class="nav-tab" :class="{ active: activeTab === 'estoque' }" @click="activeTab = 'estoque'">
              <img src="images/estoque.svg" class="icon" alt="Estoque" />
              Estoque
            </button>
          </li>
          <li>
            <button class="nav-tab" :class="{ active: activeTab === 'produtos' }" @click="activeTab = 'produtos'">
              <img src="images/produtos.svg" class="icon" alt="Produtos" />
              Produtos
            </button>
          </li>
          <li>
            <button class="nav-tab" :class="{ active: activeTab === 'producao' }" @click="activeTab = 'producao'">
              <img src="images/produção.svg" class="icon" alt="Produção" />
              Produção
            </button>
          </li>
          <li>
            <button class="nav-tab" :class="{ active: activeTab === 'financeiro' }" @click="activeTab = 'financeiro'">
              <img src="images/financeiro.svg" class="icon" alt="Financeiro" />
              Financeiro
            </button>
          </li>
          <li>
            <button class="nav-tab" :class="{ active: activeTab === 'relatorios' }" @click="activeTab = 'relatorios'">
              <img src="images/relatorio.svg" class="icon" alt="Relatórios" />
              Relatórios
            </button>
          </li>
        </ul>
      </nav>
    <!-- Estoque Tab -->
<div x-show="activeTab === 'estoque'" class="tab-content">
  <h2 class="card-title">Controle de Estoque</h2>

  <div class="card">
    <div class="card-header-flex">
      <h3>Adicionar/Editar Matéria-Prima</h3>
     <button @click="forceRefresh()" class="btn-primary">
      <img src="images/update-list.svg" alt="Atualizar" />
      Atualizar Lista
    </button>

    </div>

   <form @submit.prevent="saveStock()">
  <div class="stock-form-grid">
    <div class="stock-form-group">
      <label>Nome</label>
      <input
        type="text"
        x-model="stockForm.name"
        class="stock-form-control"
        required
      />
    </div>

    <div class="stock-form-group">
      <label>Quantidade</label>
      <input
        type="number"
        x-model="stockForm.quantity"
        class="stock-form-control"
        required
        min="0"
        step="0.01"
      />
    </div>
  </div>

  <!-- Botão abaixo dos inputs -->
  <button type="submit" class="adicionar-btn">
    <span x-show="!stockForm.id">Adicionar</span>
    <span x-show="stockForm.id">Atualizar</span>
  </button>
</form>
  </div>

  <div class="stock-search-bar">
    <input
      type="text"
      x-model="stockSearch"
      placeholder="Buscar matéria-prima..."
      class="search-box flex-1"
    />

    <button
      class="btn-primary"
      @click="stockOrder = stockOrder === 'asc' ? 'desc' : 'asc'"
    >
      Ordenar <span x-text="stockOrder === 'asc' ? 'A → Z' : 'Z → A'"></span>
    </button>
  </div>

 <div class="stock-tab">
  <table class="stock-table">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Quantidade</th>
      </tr>
    </thead>
    <tbody>
      <template x-for="item in filteredStock" :key="item.id">
        <tr>
          <td x-text="item.name"></td>
          <td x-text="item.quantity"></td>
          <td>
            <button @click="editStock(item)" class="stock-btn-warning">
              Editar
            </button>
            <button @click="deleteStock(item.id)" class="stock-btn-danger">
              Excluir
            </button>
          </td>
        </tr>
      </template>
    </tbody>
  </table>
</div>
</div>


<!-- Produtos Tab -->
<div x-show="activeTab === 'produtos'" class="tab-content produtos-tab">
  <h2 class="card-title">Cadastro de Produtos</h2>

  <div class="card produtos-card">
    <div class="card-header-flex">
      <h3>Adicionar/Editar Produto</h3>
      <button @click="forceRefresh()" class="btn-primary">
        <img src="images/update-list.svg" alt="Atualizar" />
        Atualizar Lista
      </button>
    </div>

    <form @submit.prevent="saveProduct()" class="produtos-form">
      <div class="produtos-form-grid">
  <!-- Nome -->
  <div class="form-group produtos-form-group">
    <label>Nome do Produto</label>
    <input type="text" x-model="productForm.name" class="form-control produtos-form-control" required />
  </div>

  <!-- Preço -->
  <div class="form-group produtos-form-group">
    <label>Preço de Venda (R$)</label>
    <input type="number" x-model="productForm.price" class="form-control produtos-form-control" required min="0" step="0.01" />
  </div>

  <!-- NOVA ESTRUTURA PARA INGREDIENTES -->
  <div class="ingredientes-wrapper">
    <div class="ingredientes-lista">
      <template x-for="(ingredient, index) in productForm.ingredients" :key="index">
        <div class="ingredient-item produtos-ingredient-item">
          <select
            x-model="ingredient.stockId"
            required
            class="materia-prima-select produtos-materia-prima-select"
            x-init="$nextTick(() => new TomSelect($el))"
          >
            <option value="">Selecione a matéria-prima</option>
            <template x-for="stockItem in stock" :key="stockItem.id">
              <option :value="stockItem.id" x-text="stockItem.name"></option>
            </template>
          </select>

          <input
            type="number"
            x-model="ingredient.quantity"
            placeholder="Quantidade"
            required
            min="0"
            step="0.01"
            class="produtos-input-quantidade"
          />

          <button type="button" @click="removeIngredient(index)" class="btn btn-remove produtos-btn-remove">
            ×
          </button>
        </div>
      </template>
    </div>

    <div class="botoes-produto-container">
  <button type="button" @click="addIngredient()" class="adicionar-materia-btn">
    + Adicionar Matéria-Prima
  </button>

      <button type="submit" class="produtos-btn-save">
    <span x-show="!productForm.id">Adicionar Produto</span>
    <span x-show="productForm.id">Atualizar Produto</span>
  </button>
    </form>
    </div>
  </div>
</div>
  </div>

  <!-- ✅ ESTES DOIS AGORA ESTÃO DENTRO DA ABA -->
  <input
    type="text"
    x-model="productSearch"
    placeholder="Buscar produto..."
    class="search-box produtos-search-box"
  />

  <table class="produtos-table">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Preço</th>
        <th>Ingredientes</th>
      </tr>
    </thead>
    <tbody>
      <template x-for="product in filteredProducts" :key="product.id">
        <tr>
          <td x-text="product.name"></td>
          <td x-text="'R$ ' + product.price.toFixed(2)"></td>
          <td>
            <template x-for="ing in product.ingredients">
              <div x-text="getStockName(ing.stockId) + ': ' + ing.quantity"></div>
            </template>
          </td>
          <td class="produtos-actions-cell">
            <button @click="editProduct(product)" class="produtos-btn produtos-btn-warning">Editar</button>
            <button @click="deleteProduct(product.id)" class="produtos-btn produtos-btn-danger">Excluir</button>
          </td>
        </tr>
      </template>
    </tbody>
  </table>
</div> <!-- ✅ fecha a aba de produtos aqui corretamente -->

<!-------------------------------------------------------------------------------------------------------------------------------------------->

<!-- Produção Tab -->
<div x-show="activeTab === 'producao'" class="tab-content producao-tab">
  <h2 class="card-title">Produção</h2>

  <div class="card producao-card">
    <div class="card-header-flex">
      <h3>Produzir Produto</h3>
      <button @click="forceRefresh()" class="btn-primary">
        <img src="images/update-list.svg" alt="Atualizar" />
        Atualizar Lista
      </button>
    </div>

<div class="producao-form-grid">
  <!-- Seletor de Produto + Botão abaixo -->
  <div class="form-group produto-select">
    <label>Produto</label>
    <select x-model="productionForm.productId" class="form-control">
      <option value="">Selecione o produto</option>
      <template x-for="product in products" :key="product.id">
        <option :value="product.id" x-text="product.name"></option>
      </template>
    </select>

    <div class="botoes-producao-container">
      <button
        @click="produce()"
        class="producao-btn-produzir"
        :disabled="!productionForm.productId"
      >
        Produzir
      </button>
    </div>
  </div>

  <!-- Campo de Quantidade continua ao lado -->
  <div class="form-group quantidade-input">
    <label>Quantidade</label>
    <input
      type="number"
      x-model="productionForm.quantity"
      class="form-control"
      min="1"
      value="1"
    />
  </div>
</div>
  </div>
  <div x-show="productionForm.productId" class="card">
    <h4>Matérias-primas necessárias:</h4>
    <template x-for="ingredient in getProductIngredients(productionForm.productId)">
      <div class="ingrediente-necessario">
        <span x-text="getStockName(ingredient.stockId)"></span>
        <span>
          Necessário:
          <strong x-text="(ingredient.quantity * (productionForm.quantity || 1)).toFixed(2)"></strong>
          | Disponível:
          <strong x-text="getStockQuantity(ingredient.stockId).toFixed(2)"></strong>
          <span
            x-show="getStockQuantity(ingredient.stockId) < (ingredient.quantity * (productionForm.quantity || 1))"
            class="status-erro"
          >❌</span>
          <span
            x-show="getStockQuantity(ingredient.stockId) >= (ingredient.quantity * (productionForm.quantity || 1))"
            class="status-ok"
          >✅</span>
        </span>
      </div>
    </template>
  </div>
</div>


<!-------------------------------------------------------------------------------------------------------------------------------------------->

<!-- Financeiro Tab -->
<div x-show="activeTab === 'financeiro'" class="tab-content financeiro-tab">
  <h2 class="card-title">Controle Financeiro</h2>

  <div class="financeiro-stats-grid">
    <div class="financeiro-stat-card">
      <div class="stat-value" x-text="'R$ ' + totalRevenue.toFixed(2)"></div>
      <div class="stat-label">Receita Total</div>
    </div>
    <div class="financeiro-stat-card">
      <div class="stat-value" x-text="'R$ ' + totalExpenses.toFixed(2)"></div>
      <div class="stat-label">Despesas Totais</div>
    </div>
    <div class="financeiro-stat-card">
      <div class="stat-value" x-text="'R$ ' + (totalRevenue - totalExpenses).toFixed(2)"></div>
      <div class="stat-label">Lucro</div>
    </div>
  </div>

  <div class="financeiro-form-section">
    <div class="financeiro-card">
      <h3>Registrar Venda</h3>
      <form @submit.prevent="recordSale()">
        <div class="form-group">
          <label>Produto</label>
          <select x-model="saleForm.productId" class="form-control" required>
            <option value="">Selecione o produto</option>
            <template x-for="product in products" :key="product.id">
              <option :value="product.id" x-text="product.name + ' - R$ ' + product.price.toFixed(2)"></option>
            </template>
          </select>
        </div>
        <div class="form-group">
          <label>Quantidade</label>
          <input type="number" x-model="saleForm.quantity" class="form-control" required min="1" />
        </div>
        <div class="form-group">
          <label>Cliente (opcional)</label>
          <input type="text" x-model="saleForm.customer" class="form-control" />
        </div>
        <button type="submit" class="registrar-venda-btn">Registrar Venda</button>
      </form>
    </div>

    <div class="financeiro-card">
      <h3>Registrar Despesa</h3>
      <form @submit.prevent="recordExpense()">
        <div class="form-group">
          <label>Descrição</label>
          <input type="text" x-model="expenseForm.description" class="form-control" required />
        </div>
        <div class="form-group">
          <label>Valor (R$)</label>
          <input type="number" x-model="expenseForm.amount" class="form-control" required min="0" step="0.01" />
        </div>
        <div class="form-group">
          <label>Categoria</label>
          <select x-model="expenseForm.category" class="form-control" required>
            <option value="">Selecione a categoria</option>
            <option value="materiais">Materiais</option>
            <option value="marketing">Marketing</option>
            <option value="equipamentos">Equipamentos</option>
            <option value="outros">Outros</option>
          </select>
        </div>
        <button type="submit" class="registrar-despesa-btn">Registrar Despesa</button>
      </form>
    </div>
  </div>

  <div class="financeiro-card">
    <h3>Últimas Transações</h3>
    <table class="financeiro-table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Tipo</th>
          <th>Descrição</th>
          <th>Valor</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="transaction in recentTransactions" :key="transaction.id">
          <tr>
            <td x-text="new Date(transaction.date).toLocaleDateString('pt-BR')"></td>
            <td>
              <span x-show="transaction.type === 'sale'" class="type-sale">Venda</span>
              <span x-show="transaction.type === 'expense'" class="type-expense">Despesa</span>
            </td>
            <td x-text="transaction.description"></td>
            <td :class="transaction.type === 'sale' ? 'value-sale' : 'value-expense'" x-text="(transaction.type === 'sale' ? '+' : '-') + 'R$ ' + transaction.amount.toFixed(2)"></td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>
</div>


<!-- Relatórios Tab -->
<div x-show="activeTab === 'relatorios'" class="relatorios-tab">
  <h2 class="card-title">Relatórios</h2>

  <div class="relatorios-card">
    <h3>Filtros</h3>
    <div class="relatorios-filters-grid">
      <div class="form-group">
        <label>Mês</label>
        <input type="month" x-model="reportFilters.month" class="form-control" />
      </div>
      <div class="form-group">
        <label>Ano</label>
        <input
          type="number"
          x-model="reportFilters.year"
          class="form-control"
          :value="new Date().getFullYear()"
        />
      </div>
      <div class="form-group">
        <label>&nbsp;</label>
        <button @click="generateReport()" class="gerar-relatorio-btn">Gerar</button>
      </div>
    </div>
  </div>

  <!-- Relatório gerado (visível apenas quando report existe) -->
  <template x-if="report">
    <div class="relatorios-card">
      <div class="relatorios-header">
        <h3>Relatório Mensal</h3>
        <button @click="exportToPDF()" class="exportar-pdf-btn">📄 Exportar PDF</button>
      </div>

      <div class="relatorios-stats-grid">
        <div class="relatorios-stat-card">
          <div class="stat-value" x-text="report?.totalSales || 0"></div>
          <div class="stat-label">Produtos Vendidos</div>
        </div>
        <div class="relatorios-stat-card">
          <div class="stat-value" x-text="'R$ ' + (report?.revenue || 0).toFixed(2)"></div>
          <div class="stat-label">Receita</div>
        </div>
        <div class="relatorios-stat-card">
          <div class="stat-value" x-text="'R$ ' + (report?.expenses || 0).toFixed(2)"></div>
          <div class="stat-label">Despesas</div>
        </div>
        <div class="relatorios-stat-card">
          <div
            class="stat-value"
            x-text="'R$ ' + ((report?.revenue || 0) - (report?.expenses || 0)).toFixed(2)"
          ></div>
          <div class="stat-label">Lucro Líquido</div>
        </div>
      </div>

      <div class="relatorios-duas-colunas">
        <div>
          <h4>Produtos Mais Vendidos</h4>
          <table class="relatorios-table">
            <thead>
              <tr>
                <th>Produto</th>
                <th>Quantidade</th>
                <th>Receita</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="item in report?.topProducts || []" :key="item.name">
                <tr>
                  <td x-text="item.name"></td>
                  <td x-text="item.quantity"></td>
                  <td x-text="'R$ ' + item.revenue.toFixed(2)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <div>
          <h4>Despesas por Categoria</h4>
          <table class="relatorios-table">
            <thead>
              <tr>
                <th>Categoria</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="item in report?.expensesByCategory || []" :key="item.category">
                <tr>
                  <td x-text="item.category"></td>
                  <td x-text="'R$ ' + item.amount.toFixed(2)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </template>
</div>



<!-- External JavaScript -->
    <script src="script.js"></script>
    <script src="alpine-logic.js"></script>
  </body>
</html>
